language: perl
# Use container-based infrastucture on Travis which doesn't support running
# things as root; see http://docs.travis-ci.com/user/migrating-from-legacy/
sudo: false
perl:
    - "5.16"
    - "5.18"
    - "5.20"
    - "5.22"
    #
    # Do not test on Perl 5.19 because 5.19.9 seems to mishandle UTF-8 source files
    # (see https://travis-ci.org/berkmancenter/mediacloud/jobs/28721908#L2803);
    # Perl 5.18 and 5.20 work fine though.
    #
    #- "5.19"
addons:
    postgresql: "9.3"
    hosts:
        - mediacloud.local
    apt:
        # Whitelist: https://github.com/travis-ci/apt-source-whitelist
        sources:
            # We need an up-to-date version of Gearman
            - gearman-developers
        # Whitelist: https://github.com/travis-ci/apt-package-whitelist
        # Keep in sync with "install_mediacloud_system_package_dependencies.sh"
        packages:
            - build-essential
            - cpanminus
            - curl
            - g++
            - gawk
            - gcc
            - graphviz
            - graphviz-dev
            - libdb-dev
            - libexpat1
            - libexpat1-dev
            - libgearman-dev
            - libgraph4
            - libgraphviz-dev
            - libxml2-dev
            - libxslt1-dbg
            - libxslt1-dev
            - libxslt1.1
            - libyaml-0-2
            - libyaml-dev
            - make
            - netcat
            - openjdk-7-jdk
            - openjdk-7-jre-headless
            - pandoc
            - postgresql-server-dev-all
            - python-dev
            - python-software-properties
            - python-virtualenv
            - tidy
cache:
    directories:
        # Carton dependencies
        - local/
        # Pip cache
        - $HOME/.cache/pip
        # Python modules from "requirements.txt"
        - $HOME/mc-python/lib
before_cache:
    - rm -f $HOME/.cache/pip/log/debug.log
env:
    global:
        # Facebook Graph API credentials for testing:
        # * MC_FACEBOOK_APP_ID
        # * MC_FACEBOOK_APP_SECRET
        - secure: "TklAqxPSqywPk5khp54R7iYW9jGfuWYiVC7xY3wiO8GQHRpW3b0a6zR3yEbeBMvKMt5b1IaCCJwuyasP/W0xPopqozqJFr/6045/tfTqRQ7/Bo6noJ1a640yLjjDzlGenHqkTCbhp5y4kaT2BS1IoTi423FOXQB1OVTpVD55jAw="
        - secure: "A9bwQIK5W8VyQlpdnoA6LhKTcllytTS/8ueyzi9Y7F6xFdD2sFnfTy6UgpFIzgtVezYJYqy7Wcr1RiC3ybOmsE4FSYRTptrEdu4Pf/nI/LRxDE+sF2kPDGrXRD8iTL5+K2h5DMbBG2NsoflC+qRgn1W9f/Ey1gMsmCyOJJCnufw="
        # Amazon S3 test bucket credentials:
        # * MC_AMAZON_S3_TEST_ACCESS_KEY_ID
        # * MC_AMAZON_S3_TEST_SECRET_ACCESS_KEY
        # * MC_AMAZON_S3_TEST_BUCKET_NAME
        # * MC_AMAZON_S3_TEST_DIRECTORY_NAME
        - secure: "DpYY9zJCMOABwBUhW5tTLRjWgKKNgkWBH/i5x2hJTSkY53erpaaqTPzs/loGbiV1Q+TUu0PWPqRQh9eovDKd2/l2taXECbQi+gY/VprlYK4rqruLXci9mxJepIp9imITiCwxZB9hYI3BDxQYBvPDx0coklEi5bG017HZNlwYQfg="
        - secure: "ONqZb6dPH8uNcCVkLH722JPhP4Zua8QjbYcj24ob27LVrjh9UbSAUVMu+3XVczY0dERsGGcqH2bhaG3WYINAs0wnbyPfbAokHtRSrIcDfSfVkDfCzJkYl7jc1Dhc/lV/pe6ygqtGZQG+Whx/dKf6DpCJmpEekeHavwVDxzC1D+4="
        - secure: "Y3poZS6KCMfAyXmAG4hvHhCtaUHLl3UwB2CYjDLp2ki86tDtG7JfEJp2Q/8C610nzBw6WlA8bdljM9dxNHR6aEGHPxLz1NsGMLw8xYZFoMrw6RMpRq6BLcraylAmVZAFC2GTClqzHMWfW6mCQ5a5OznUWsJ6n4tP0aoPLjRpUgw="
        - secure: "GHU56Kl7zaE00MZeaPqie3e8xoxLaGnh3A03xZbG8/707tPtBsPLfPDaCSQf9PSstajVjPik+tUNuOTgyz9AD5ma3dwPdJ6VhpFNS/DD8+CDlojmgEfuvaVD7Bi3sLFuop/PWrNoi0pND45lv8O8shQ1WruHEWPgYxW10vd3Q7Y="
        # Do not ask for confirmation when running ./script/mediawords_create_db.pl
        - MEDIAWORDS_CREATE_DB_DO_NOT_CONFIRM=1
        # Enable Python API tests in ./script/run_test_suite_for_devel_cover.sh
        - MEDIACLOUD_ENABLE_PYTHON_API_TESTS=1
        # Test PythonReadability extractor method in t/test_extractor.t
        - MC_TEST_EXTRACTOR_PYTHONREADABILITY=1
before_install:
    # Set up local Media Cloud environment for Python
    - mkdir -p $HOME/mc-python
    - virtualenv $HOME/mc-python
    - source $HOME/mc-python/bin/activate
    # Create + switch to the Media Cloud's Perlbrew library
    - perlbrew lib create mediacloud
    - perlbrew switch @mediacloud
    # Install Media Cloud system package dependencies
    - ./install_modules_outside_of_carton.sh
    # (Re)install Carton dependencies (which might be restored from cache into
    # "local/" already in which case we just check if Carton is happy with the
    # current setup)
    - ./install_modules_with_carton.sh
    # Install Python dependencies
    - travis_retry pip install --upgrade pip setuptools
    - travis_retry pip install --upgrade -r python_scripts/requirements.txt
    # install Media Cloud testing variant of the Python  Client
    - travis_retry git clone https://github.com/dlarochelle/MediaCloud-API-Client.git
    - cd MediaCloud-API-Client/; git checkout 51a045a; cd ../
    - travis_retry pip install --editable MediaCloud-API-Client/
install:
    # Use default configuration
    - cp mediawords.yml.dist mediawords.yml
    # Create PostgreSQL database
    - ./install_scripts/create_default_db_user_and_databases.sh
before_script:
    # Initialize PostgreSQL database
    - ./script/run_with_carton.sh ./script/mediawords_create_db.pl
script:
    # Start Readability service for testing "PythonReadability" extractor method on t/test_extractor.t
    - "python python_scripts/extractor_python_readability_server.py &"
    # Run Media Cloud's test suite, report test coverage to https://coveralls.io/r/berkmancenter/mediacloud
    - ./script/run_test_suite_for_devel_cover.sh coveralls --destroy-solr
after_failure:
    # Print out the test log
    - echo
    - echo "Unit test(s) have failed; here's the full log:"
    - echo
    - cat data/run_test_suite.log
