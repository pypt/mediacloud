;
; Media Cloud configuration file for Supervisor (http://supervisord.org/)
;
; DO NOT EDIT THIS FILE. THIS FILE IS RECREATED DURING EACH CALL TO supervisord.sh BY APPLYING
; mediawords.yml TO supervisor.cont.tt2. TO EDIT THE INDIVIDUAL process PROPERTIES, SEE
; mediawords.yml.
;
; To add your own services to Supervisor, create
; "supervisord.user.service_name.conf" and add your additional configuration
; properties there.
;

[%- BLOCK program_config %]

[program:[% program %]]
    [%- IF worker_module %]
        [%- command = './script/run_with_carton.sh local/bin/mjm_worker.pl lib/MediaWords/Job/' _ worker_module %]
    [%- END %]
    [%- nice = supervisor.programs.$program.nice || default_nice || 10 %]
    [%- IF nice %]
        [%- command = "/usr/bin/nice -n $nice $command" %]
    [%- END %]
command = [% command %]
directory = %(here)s/../
autorestart = [% supervisor.programs.$program.autorestart_b|| default_autorestart  %]
autostart = [% supervisor.programs.$program.autostart_b || default_autostart  %]
stopasgroup = [% supervisor.programs.$program.stopasgroup_b || default_stopasgroup  %]
;killasgroup = [% supervisor.programs.$program.killasgroup_b || default_killasgroup %]
priority = [% priority || 20 %]
    [%- UNLESS skip_numprocs %]
    [%- numprocs = supervisor.programs.$program.numprocs || default_numprocs || 1 %]
numprocs = [% numprocs %]
        [%- IF numprocs > 1 %]
process_name = %(program_name)s_%(process_num)02d
        [%- END %]
    [%- END %]
    [%- IF stopwaitsecs %]
stopwaitsecs=[% stopwaitsecs %]
    [%- END %]
    [%- IF stopsignal %]
stopsignal=[% stopsignal %]
    [%- END %]
[%- END %]

[inet_http_server]
port = 127.0.0.1:4398
username = supervisord
password = qHujfp7n4J

[supervisord]
logfile = %(here)s/../data/supervisor_logs/supervisord.log  ; main log file (default $CWD/supervisord.log)
pidfile = %(here)s/../data/supervisor_logs/supervisord.pid     ; supervisord pidfile (default supervisord.pid)
# DO NOT set "childlogdir" here because it is set by the supervisord.sh script
;childlogdir = %(here)s/../data/supervisor_logs/            ; ('AUTO' child log dir, default $TEMP)
directory = %(here)s/../                                    ; chroot to Media Cloud's root directory
nocleanup = true                                            ; don't remove process logs after stopping the process

; The below section must remain in the config file for RPC (supervisorctl /
; web interface) to work, additional interfaces may be added by defining them
; in separate rpcinterface: sections
[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl = unix://%(here)s/supervisord.sock                ; use a unix:// URL for a unix socket

[group:mc]
programs = crawler

[%- crawler_numprocs = supervisor.programs.crawler.numprocs || 1 %]
[% INCLUDE program_config
    program='crawler'
    command="bash ./script/run_with_carton.sh ./script/mediawords_crawl.pl $crawler_numprocs"
    default_stopasgroup='false'
    default_killasgroup='false'
    default_autorestart='false'
    default_autostart='true'
    skip_numprocs=1
    default_nice=5
%]


[% INCLUDE program_config
    program='reextract_stories_without_readability_tag'
    command="bash ./script/run_with_carton.sh ./script/reextract_stories_without_readability_tag.pl"
    default_stopasgroup='true'
    default_killasgroup='true'
    default_autorestart='false'
    default_autostart='true'
    priority=5
    default_nice=12
%]

[% INCLUDE program_config
    program='process_bitly_schedule'
    command="bash ./script/run_with_carton.sh ./script/process_bitly_schedule.pl"
    default_stopasgroup='true'
    default_killasgroup='true'
    default_autorestart='false'
    default_autostart='true'
    priority=5
    default_nice=12
%]

; Job brokers
[group:job_broker]
programs = rabbitmq

[% INCLUDE program_config
    program='rabbitmq'
    command='bash ./script/rabbitmq_wrapper.sh'
    default_stopasgroup='true'
    default_killasgroup='true'
    default_autorestart='true'
    default_autostart='true'
    stopsignal='INT'
    stopwaitsecs=60
    priority=10
    default_nice=0
%]

[% INCLUDE program_config
    program='rescrape_media'
    worker_module='RescrapeMedia.pm'
    default_stopasgroup='false'
    default_killasgroup='false'
    default_autorestart='false'
    default_autostart='true'
    default_nice=10
%]

[% INCLUDE program_config
    program='extract_and_vector'
    worker_module='ExtractAndVector.pm'
    default_stopasgroup='false'
    default_killasgroup='false'
    default_autorestart='false'
    default_autostart='true'
    default_nice=12
%]

[% INCLUDE program_config
    program='topic_mine'
    worker_module='TM/MineTopic.pm'
    default_stopasgroup='false'
    default_killasgroup='false'
    default_autorestart='false'
    default_autostart='true'
    default_nice=10
%]

[% INCLUDE program_config
    program='topic_snapshot'
    worker_module='TM/SnapshotTopic.pm'
    default_stopasgroup='false'
    default_killasgroup='false'
    default_autorestart='false'
    default_autostart='true'
    default_nice=10
%]

[% INCLUDE program_config
    program='annotate_with_corenlp'
    worker_module='AnnotateWithCoreNLP.pm'
    default_stopasgroup='false'
    default_killasgroup='false'
    default_autorestart='false'
    default_autostart='true'
    default_nice=10
%]

[% INCLUDE program_config
    program='bitly_fetch_story_stats'
    worker_module='Bitly/FetchStoryStats.pm'
    default_stopasgroup='false'
    default_killasgroup='false'
    default_autorestart='false'
    default_autostart='true'
    default_nice=10
%]

[% INCLUDE program_config
    program='bitly_aggregate_story_stats'
    worker_module='Bitly/AggregateStoryStats.pm'
    default_stopasgroup='false'
    default_killasgroup='false'
    default_autorestart='false'
    default_autostart='true'
    default_nice=10
%]

[% INCLUDE program_config
    program='facebook_fetch_story_stats'
    worker_module='Facebook/FetchStoryStats.pm'
    default_stopasgroup='false'
    default_killasgroup='false'
    default_autorestart='false'
    default_autostart='true'
    default_nice=10
%]

[group:solr]
programs = solr

[% INCLUDE program_config
    program='solr'
    command='bash ./script/run_with_carton.sh ./solr/scripts/run_singleton_solr_server.pl'
    default_stopasgroup='false'
    default_killasgroup='false'
    default_autorestart='true'
    default_autostart='true'
    stopwaitsecs=20
    default_nice=0
%]

[group:thrift]
programs=extractor_python_readability_server

[% INCLUDE program_config
    program='extractor_python_readability_server'
    command='python python_scripts/extractor_python_readability_server.py'
    default_stopasgroup='true'
    default_killasgroup='true'
    default_autorestart='true'
    default_autostart='true'
    default_nice=12
%]


; Include custom user's configuration
[include]
files = supervisord.user.*.conf
